<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earn Cash Pro 2025 - Final</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- Ad Network SDK -->
    <script src='//libtl.com/sdk.js' data-zone='10357842' data-sdk='show_10357842'></script>
<script>(function(s){s.dataset.zone='10359357',s.src='https://gizokraijaw.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>

    <style>
        :root { --primary: #007aff; --success: #32d74b; --warning: #ffa500; --danger: #ff3b30; --bg: #121212; --card: #1e1e1e; --text-light: #f0f0f0; --text-dark: #ccc; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text-light); margin: 0; padding: 0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .app-container { width: 100%; max-width: 450px; background: var(--card); min-height: 100vh; padding: 20px; margin: auto; box-sizing: border-box; display: flex; flex-direction: column; }
        
        .balance-card { background: linear-gradient(135deg, #007aff, #0051a8); padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,122,255,0.3); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #2c2c2c; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #3d3d3d; }
        .stat-box small { color: var(--text-dark); display: block; margin-bottom: 5px; }
        
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 12px; transition: background-color 0.3s, transform 0.1s; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; box-sizing: border-box; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-warning { background-color: var(--warning); color: #000; }
        .btn-danger { background-color: var(--danger); }
        .btn-disabled { background-color: #444 !important; color: #888 !important; cursor: not-allowed; }

        #cooldownBox { display: none; background: rgba(255, 59, 48, 0.1); border: 1px dashed var(--danger); padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 15px; color: var(--danger); }
        #timerDisplay { font-size: 26px; font-weight: bold; font-family: monospace; }

        .refer-card { background: rgba(50, 215, 75, 0.1); padding: 20px; border-radius: 18px; border: 1px dashed var(--success); text-align: center; margin-top: 15px; margin-bottom: 15px; }
        .history-item { background: #2a2a2c; padding: 15px; border-radius: 12px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--primary); }

        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #444; background: #2c2c2c; color: white; box-sizing: border-box; font-size: 16px; }
        input::placeholder { color: #888; }
        .screen { display: none; width: 100%; }
        .active { display: block !important; }
        .link { color: var(--primary); cursor: pointer; font-weight: bold; }
        .form-footer { text-align: center; color: var(--text-dark); }
        h2, h3, h4 { text-align: center; }
        #welcomeMessage { margin-top: 0; margin-bottom: 20px; color: var(--text-light); font-weight: 500;}
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login, Register, Withdraw Screens are unchanged -->
        <div id="loginScreen" class="screen active"> <h2>Login</h2> <input type="email" id="loginEmail" placeholder="Email"> <input type="password" id="loginPass" placeholder="Password"> <button class="btn btn-primary" onclick="loginUser()">Login</button> <p class="form-footer">New here? <span onclick="showScreen('regScreen')" class="link">Create Account</span></p> </div>
        <div id="regScreen" class="screen"> <h2>Register</h2> <input type="text" id="regName" placeholder="Name"> <input type="email" id="regEmail" placeholder="Email"> <input type="password" id="regPass" placeholder="Password (Min 6 characters)"> <input type="text" id="regRefer" placeholder="Refer Code (Optional)"> <button class="btn btn-primary" onclick="registerUser()">Sign Up</button> <button class="btn" style="background:#444;" onclick="showScreen('loginScreen')">Back to Login</button> </div>
        <div id="dashboardScreen" class="screen"> <h3 id="welcomeMessage">Welcome!</h3> <div class="balance-card"> <small>Total Balance</small> <div id="userBalance" style="font-size:35px; font-weight:bold;">0.00 BDT</div> </div> <div class="stats-grid"> <div class="stat-box"><small>Ads Watched</small><strong id="userAds" style="color:var(--primary);">0/20</strong></div> <div class="stat-box"><small>Total Refers</small><strong id="userRefers" style="color:var(--success);">0</strong></div> </div> <div id="cooldownBox"> <strong>Task Limit Over! Wait:</strong><br> <div id="timerDisplay">03:00:00</div> </div> <button id="adBtn" class="btn btn-primary" onclick="handleAdClick()">Watch Ad & Earn</button> <div class="refer-card"> <span style="color:var(--success); font-weight:bold;">Refer & Earn 5 BDT!</span><br> <div id="userRefCode" style="font-size:22px; font-weight:bold; margin:10px 0; color:var(--primary);">------</div> <button class="btn btn-success" style="padding:10px; font-size:14px;" onclick="copyReferLink()">Copy Referral Link</button> </div> <button class="btn btn-warning" onclick="showScreen('withdrawScreen')">Withdraw Money</button> <h4 style="margin-top:20px;">Withdraw History</h4> <div id="historyList">Loading history...</div> <button class="btn btn-danger" style="margin-top:20px;" onclick="logout()">Logout</button> </div>
        <div id="withdrawScreen" class="screen"> <h3>Withdraw Funds</h3> <select id="wMethod"> <option value="Bkash">Bkash (Min 50 BDT)</option> <option value="Nagad">Nagad (Min 50 BDT)</option> <option value="Recharge">Recharge (Min 20 BDT)</option> </select> <input type="number" id="wAmount" placeholder="Amount"> <input type="text" id="wPhone" placeholder="Phone Number"> <button class="btn btn-success" onclick="submitWithdraw()">Submit Request</button> <button class="btn" style="background:#444;" onclick="showScreen('dashboardScreen')">Back</button> </div>
    </div>

    <script>
        const config = { AD_REWARD: 0.05, AD_LIMIT: 20, REFER_REWARD: 5, COOLDOWN_HOURS: 3, MIN_WITHDRAW: { Bkash: 50, Nagad: 50, Recharge: 20 } };
        const firebaseConfig = { apiKey: "AIzaSyAnNUHLN9R-HlSkbv6c0zw7PxrUZIqqCEA", authDomain: "refer-and-earn-f924e.firebaseapp.com", projectId: "refer-and-earn-f924e", storageBucket: "refer-and-earn-f924e.firebasestorage.app", messagingSenderId: "737790821100", appId: "1:737790821100:web:11b6bcdc9fc5644bdf1bc9" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let timerInt; let currentUserData = {};

        function showScreen(screenId) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(screenId).classList.add('active'); }

        auth.onAuthStateChanged(user => {
            if (user) { showScreen('dashboardScreen'); setupListeners(user.uid); } 
            else { showScreen('loginScreen'); if (timerInt) clearInterval(timerInt); }
        });

        function setupListeners(uid) {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if (!doc.exists) { console.error("User document does not exist."); return; }
                currentUserData = doc.data();
                updateDashboardUI(currentUserData);
                
                // --- TIMER LOGIC IMPROVEMENT ---
                // If lastTaskTime is set, it means user is in cooldown.
                if (currentUserData.lastTaskTime) {
                    const taskTime = currentUserData.lastTaskTime.toMillis();
                    startCooldownTimer(taskTime);
                } else {
                    // If no cooldown is active, stop any previous timers and hide the box.
                    if (timerInt) clearInterval(timerInt);
                    document.getElementById('cooldownBox').style.display = 'none';
                    updateAdButtonState();
                }

            }, err => console.error("Error fetching user data:", err));

            db.collection('withdrawals').where('uid', '==', uid).orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                let html = '';
                if (snapshot.empty) { html = '<p style="text-align:center; color: var(--text-dark);">No withdrawal history yet.</p>'; } 
                else { snapshot.forEach(doc => { const w = doc.data(); const statusColor = w.status === 'Success' ? 'var(--success)' : (w.status === 'Pending' ? 'var(--warning)' : 'var(--danger)'); html += `<div class="history-item"><span>${w.method} - ${w.amount} BDT</span><strong style="color:${statusColor}">${w.status}</strong></div>`; }); }
                document.getElementById('historyList').innerHTML = html;
            }, err => { console.error("Error fetching history:", err); document.getElementById('historyList').innerHTML = '<p style="text-align:center; color: var(--danger);">Could not load history.</p>'; });
        }

        function updateDashboardUI(data) {
            document.getElementById('welcomeMessage').innerText = `Welcome, ${data.name || 'User'}!`;
            document.getElementById('userBalance').innerText = `${data.balance.toFixed(2)} BDT`;
            document.getElementById('userAds').innerText = `${data.adsWatchedToday}/${config.AD_LIMIT}`;
            document.getElementById('userRefers').innerText = data.referCount || 0;
            document.getElementById('userRefCode').innerText = data.referCode;
        }

        function updateAdButtonState() {
            const adBtn = document.getElementById('adBtn');
            if (currentUserData.adsWatchedToday >= config.AD_LIMIT) {
                adBtn.disabled = true;
                adBtn.classList.add('btn-disabled');
                adBtn.innerText = "Daily Limit Reached";
            } else {
                adBtn.disabled = false;
                adBtn.classList.remove('btn-disabled');
                adBtn.innerText = "Watch Ad & Earn";
            }
        }

        async function handleAdClick() {
            const adBtn = document.getElementById('adBtn');
            if (adBtn.disabled) return;
            if (currentUserData.adsWatchedToday >= config.AD_LIMIT) { return alert(`Daily limit of ${config.AD_LIMIT} ads reached.`); }
            
            adBtn.disabled = true; adBtn.innerText = "Loading Ad..."; adBtn.classList.add('btn-disabled');
            try {
                if (typeof show_10357842 === 'function') { await show_10357842(); await grantReward(); } 
                else { console.warn("Ad SDK function not found."); alert("Ad network not available."); updateAdButtonState(); }
            } catch (error) { console.error("Ad failed:", error); alert("Could not show ad."); updateAdButtonState(); }
        }

        async function grantReward() {
            const userRef = db.collection('users').doc(auth.currentUser.uid);
            const newCount = (currentUserData.adsWatchedToday || 0) + 1;
            let updateData = { balance: firebase.firestore.FieldValue.increment(config.AD_REWARD), adsWatchedToday: newCount };
            if (newCount >= config.AD_LIMIT) {
                updateData.lastTaskTime = firebase.firestore.FieldValue.serverTimestamp();
            }
            await userRef.update(updateData);
        }

        function startCooldownTimer(startTimeMillis) {
            const cooldownBox = document.getElementById('cooldownBox');
            const timerDisplay = document.getElementById('timerDisplay');
            const adBtn = document.getElementById('adBtn');
            const endTime = startTimeMillis + (config.COOLDOWN_HOURS * 60 * 60 * 1000);
            
            if (timerInt) clearInterval(timerInt);
            
            timerInt = setInterval(async () => {
                const diff = endTime - Date.now();
                if (diff <= 0) {
                    clearInterval(timerInt);
                    cooldownBox.style.display = 'none';
                    if (auth.currentUser) {
                        // Reset user's state for the new cycle
                        await db.collection('users').doc(auth.currentUser.uid).update({ adsWatchedToday: 0, lastTaskTime: null });
                    }
                } else {
                    // While in cooldown, show timer and disable button
                    cooldownBox.style.display = 'block';
                    adBtn.disabled = true; 
                    adBtn.classList.add('btn-disabled'); 
                    adBtn.innerText = "Locked";
                    const h = Math.floor(diff/3600000).toString().padStart(2,'0'); 
                    const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0'); 
                    const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                    timerDisplay.innerText = `${h}:${m}:${s}`;
                }
            }, 1000);
        }
        
        // --- Other functions (Login, Register, Withdraw, etc.) are unchanged ---
        async function registerUser() { const name = document.getElementById('regName').value, email = document.getElementById('regEmail').value, pass = document.getElementById('regPass').value, referCode = document.getElementById('regRefer').value.toUpperCase().trim(); if (!name || !email || pass.length < 6) return alert("Please fill all fields correctly."); try { const res = await auth.createUserWithEmailAndPassword(email, pass); if (referCode) { const refQuery = await db.collection('users').where('referCode', '==', referCode).get(); if (!refQuery.empty) { await db.collection('users').doc(refQuery.docs[0].id).update({ balance: firebase.firestore.FieldValue.increment(config.REFER_REWARD), referCount: firebase.firestore.FieldValue.increment(1) }); } } await db.collection('users').doc(res.user.uid).set({ name: name, email: email, balance: 0, adsWatchedToday: 0, referCode: Math.random().toString(36).substring(2, 8).toUpperCase(), referCount: 0, lastTaskTime: null, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); } catch (err) { alert(`Registration failed: ${err.message}`); } }
        async function loginUser() { const email = document.getElementById('loginEmail').value, pass = document.getElementById('loginPass').value; if (!email || !pass) return alert("Please enter email and password."); try { await auth.signInWithEmailAndPassword(email, pass); } catch (err) { alert(`Login failed: ${err.message}`); } }
        function logout() { auth.signOut(); }
        async function submitWithdraw() { const method = document.getElementById('wMethod').value, amount = parseFloat(document.getElementById('wAmount').value), phone = document.getElementById('wPhone').value; if (!amount || !phone) return alert("Please fill all fields."); if (isNaN(amount) || amount <= 0) return alert("Invalid amount."); if (currentUserData.balance < amount) return alert("Insufficient balance."); const minAmount = config.MIN_WITHDRAW[method]; if (amount < minAmount) return alert(`Minimum withdrawal for ${method} is ${minAmount} BDT.`); try { await db.collection('withdrawals').add({ uid: auth.currentUser.uid, method: method, amount: amount, phone: phone, status: 'Pending', timestamp: firebase.firestore.FieldValue.serverTimestamp() }); await db.collection('users').doc(auth.currentUser.uid).update({ balance: firebase.firestore.FieldValue.increment(-amount) }); alert("Withdrawal request submitted successfully!"); showScreen('dashboardScreen'); document.getElementById('wAmount').value = ''; document.getElementById('wPhone').value = ''; } catch (error) { console.error("Withdrawal error: ", error); alert("Failed to submit request."); } }
        function copyReferLink() { const code = document.getElementById('userRefCode').innerText; if (code === '------') return; const link = `https://t.me/Earning00100_bot?start=${code}`; navigator.clipboard.writeText(link).then(() => alert("Referral Link Copied!"), () => alert("Could not copy link.")); }

    </script>
</body>
                                                                                                                                                                             </html>
