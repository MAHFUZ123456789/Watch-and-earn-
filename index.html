<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earn Cash - Fast Ad Edition</title>

    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-firestore.js"></script>
    
    <script>(function(s){s.dataset.zone='10359357',s.src='https://gizokraijaw.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>

    <script src='//libtl.com/sdk.js' data-zone='10357842' data-sdk='show_10357842'></script>

    <style>
        :root {
            --primary: #007aff;
            --success: #32d74b;
            --warning: #ffa500;
            --bg: #121212;
            --card: #1e1e1e;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: #fff; margin: 0; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 500px; background: var(--card); min-height: 100vh; padding: 20px; box-sizing: border-box; }
        
        .balance-card { background: linear-gradient(135deg, #007aff, #0051a8); padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 20px; }
        .balance-amount { font-size: 36px; font-weight: bold; display: block; }
        
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #2c2c2c; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #3d3d3d; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 15px; transition: 0.3s; }
        .btn-ad { background-color: var(--primary); color: white; }
        .btn-withdraw { background-color: var(--warning); color: black; }
        .btn-submit { background-color: var(--success); color: white; }
        
        #waitTimerBox { display: none; background: rgba(255, 59, 48, 0.1); border: 1px dashed #ff3b30; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 15px; color: #ff3b30; font-weight: bold; }

        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #444; background: #2c2c2c; color: white; box-sizing: border-box; }

        .history-item { background: #2a2a2c; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; border-left: 5px solid var(--primary); }
        .status-pending { color: var(--warning); }
        .status-success { color: var(--success); }
        
        .screen { display: none; }
        .active-screen { display: block; }
    </style>
</head>
<body>
    <div class="app-container">
        
        <div id="dashboardScreen" class="screen active-screen">
            <h3 style="text-align: center; color: var(--primary);"> Dashboard</h3>
            
            <div class="balance-card">
                <span style="opacity: 0.8;">Total Balance</span>
                <span id="dashBalance" class="balance-amount">0.00 BDT</span>
            </div>

            <div class="stats-row">
                <div class="stat-box">
                    <small>Ads Today</small><br>
                    <strong id="adsCount" style="font-size: 20px;">0 / 20</strong>
                </div>
                <div class="stat-box">
                    <small>Referals</small><br>
                    <strong id="refCount" style="font-size: 20px;">0</strong>
                </div>
            </div>

            <button id="watchAdBtn" class="btn btn-ad" onclick="showAdInstantly()"> Watch & Earn</button>
            
            <div id="waitTimerBox">Next Work In: <span id="waitTime">03:00:00</span></div>

            <button class="btn btn-withdraw" onclick="toggleScreen('withdrawScreen')"> Withdraw Money</button>

            <div class="stat-box" style="margin-bottom: 20px;">
                <p style="color: #ffd60a; margin: 0;"> Refer Code: <strong id="refCodeDisp">...</strong></p>
            </div>

            <div style="margin-top: 20px;">
                <h4 style="text-align: center; color: var(--primary);"> Withdraw History</h4>
                <div id="historyList">Loading...</div>
            </div>

            <button class="btn" style="background: #ff3b30; margin-top: 20px;" onclick="auth.signOut()">Logout</button>
        </div>

        <div id="withdrawScreen" class="screen">
            <h3 style="text-align: center;">My Withdraw Request</h3>
            <select id="wMethod">
                <option value="Recharge">Mobile Recharge (Min 20TK)</option>
                <option value="Bkash">Bkash (Min 50TK)</option>
                <option value="Nagad">Nagad (Min 50TK)</option>
            </select>
            <input type="number" id="wAmount" placeholder="Amount">
            <input type="text" id="wPhone" placeholder="Phone Number">
            <button class="btn btn-submit" onclick="processWithdraw()">Submit Request</button>
            <button class="btn" style="background: #444;" onclick="toggleScreen('dashboardScreen')">Back</button>
        </div>
    </div>

    <script>
        // Firebase Config (Keep your original config)
        const firebaseConfig = {
            apiKey: "AIzaSyAnNUHLN9R-HlSkbv6c0zw7PxrUZIqqCEA",
            authDomain: "refer-and-earn-f924e.firebaseapp.com",
            projectId: "refer-and-earn-f924e",
            storageBucket: "refer-and-earn-f924e.firebasestorage.app",
            messagingSenderId: "737790821100",
            appId: "1:737790821100:web:11b6bcdc9fc5644bdf1bc9"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ১. টাইমার ছাড়া সরাসরি অ্যাড দেখানোর ফাংশন
        function showAdInstantly() {
            // SDK ফাংশন কল করা
            if (typeof show_10357842 === 'function') {
                show_10357842().then(() => {
                    addBalance();
                }).catch(() => {
                    addBalance(); // এরর হলেও রিওয়ার্ড দেওয়া
                });
            } else {
                // সরাসরি লিঙ্ক ওপেন করা যদি SDK কাজ না করে
                window.open('https://libtl.com/sdk.js?zone=10357842', '_blank');
                addBalance();
            }
        }

        async function addBalance() {
            const user = auth.currentUser;
            if(!user) return;
            const ref = db.collection('users').doc(user.uid);
            await ref.update({
                balance: firebase.firestore.FieldValue.increment(0.10),
                adsWatchedToday: firebase.firestore.FieldValue.increment(1)
            });
            alert("Success! 0.10 BDT added.");
        }

        // ২. উইথড্র ও ডাটা আপডেট
        async function processWithdraw() {
            const method = document.getElementById('wMethod').value;
            const amount = parseFloat(document.getElementById('wAmount').value);
            const phone = document.getElementById('wPhone').value;
            const user = auth.currentUser;

            if(!amount || !phone) return alert("Fill all fields");
            
            const userDoc = await db.collection('users').doc(user.uid).get();
            const balance = userDoc.data().balance;

            if(amount > balance) return alert("Low balance!");

            await db.collection('withdrawals').add({
                uid: user.uid, method, amount, phone, status: 'Pending', timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection('users').doc(user.uid).update({ balance: firebase.firestore.FieldValue.increment(-amount) });
            alert("Request sent!");
            toggleScreen('dashboardScreen');
        }

        // ৩. রিয়েল-টাইম ডাটা লিসেনার
        auth.onAuthStateChanged(user => {
            if(user) {
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    const d = doc.data();
                    document.getElementById('dashBalance').textContent = d.balance.toFixed(2) + " BDT";
                    document.getElementById('adsCount').textContent = `${d.adsWatchedToday || 0} / 20`;
                    document.getElementById('refCount').textContent = d.referCount || 0;
                    document.getElementById('refCodeDisp').textContent = d.referCode || "...";

                    if(d.adsWatchedToday >= 20 && d.lastAdBatchTime) {
                        runLimitTimer(d.lastAdBatchTime.toDate());
                    }
                });

                db.collection('withdrawals').where('uid', '==', user.uid).onSnapshot(snap => {
                    let h = '';
                    snap.forEach(doc => {
                        const x = doc.data();
                        h += `<div class="history-item">
                                <div><strong>${x.method}</strong><br><small>${x.phone}</small></div>
                                <div style="text-align:right"><strong>${x.amount}৳</strong><br><span class="status-${x.status.toLowerCase()}">${x.status}</span></div>
                             </div>`;
                    });
                    document.getElementById('historyList').innerHTML = h || "No history.";
                });
            }
        });

        function toggleScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
        }

        function runLimitTimer(start) {
            const box = document.getElementById('waitTimerBox');
            const btn = document.getElementById('watchAdBtn');
            setInterval(() => {
                const diff = (start.getTime() + (3*60*60*1000)) - new Date().getTime();
                if(diff <= 0) {
                    box.style.display = 'none';
                    btn.disabled = false;
                    return;
                }
                btn.disabled = true;
                box.style.display = 'block';
                const h = Math.floor(diff/3600000);
                const m = Math.floor((diff%3600000)/60000);
                const s = Math.floor((diff%60000)/1000);
                document.getElementById('waitTime').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }
    </script>
</body>
                                                                                                         </html>
